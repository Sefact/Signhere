<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.signhere.mapper.DocumentInter">

	<select id="searchCompletedDocs" parameterType="DocumentBean" resultType="DocumentBean">
		SELECT DM.DOCUMENT_NUM AS dmNum,
		DM.COMPANY_CODE AS cmCode,
		DM.DOCUMENT_TITLE AS dmTitle,
		DM.APPROVAL_CODE AS apCode,
		DM.DOCUMENT_CODE AS dmCode,
		MM.ID AS dmWriteId,
		MM.NAME AS dmWriter,
		DM.DOCUMENT_DATE AS dmDate 
		FROM DM INNER JOIN MM ON DM.WRITER = MM.ID AND DM.COMPANY_CODE = MM.COMPANY_CODE 
		WHERE DM.COMPANY_CODE=#{cmCode} 
        AND DOCUMENT_NUM LIKE '%'|| #{dmNum} ||'%' 
		AND MM.NAME LIKE '%'|| #{dmWriter} ||'%' 
		AND DOCUMENT_TITLE LIKE '%'|| #{dmTitle} ||'%' 
		AND DOCUMENT_CODE LIKE '%'|| #{dmCode} ||'%' 
		AND APPROVAL_CODE = 'C'   
		AND DOCUMENT_DATE BETWEEN TO_DATE(#{dmDate},'YYYYMMDD') AND TO_DATE(#{dmDate2},'YYYYMMDD') 
	</select>
  	
	<select id="countMyDraft" resultType="Integer">
		SELECT COUNT(*) FROM DM WHERE WRITER = #{senderId} AND DOCUMENT_CODE='D'
	</select>
	
	<select id="myDraft" parameterType="hashmap" resultType="hashmap">
		<![CDATA[		
			SELECT * FROM(
				SELECT  DISTINCT 
				DM.DOCUMENT_NUM AS "dmNum",
        		DM.DOCUMENT_TITLE AS "dmTitle",
        		APS.APPROVAL_NAME AS "apName",
        		DOCUMENT_DATE AS "dmDate",
				ROWNUM AS RNUM
        		FROM MM
        		INNER JOIN DM
        		ON MM.COMPANY_CODE = DM.COMPANY_CODE
        		INNER JOIN APS
        		ON DM.APPROVAL_CODE = APS.APPROVAL_CODE
        		WHERE WRITER = #{senderId} AND DOCUMENT_CODE='D'
				AND ROWNUM <= #{page} * #{perPageNum}) 
				WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select> 		
        		
	<select id="countMyEnforceMent" resultType="Integer">
		SELECT COUNT(*) FROM DM WHERE WRITER = #{senderId} AND DOCUMENT_CODE='E'
	</select>
	
	<select id="myEnforceMent" parameterType="hashmap" resultType="hashmap">
	<![CDATA[		
			SELECT * FROM(
				SELECT  DISTINCT 
				DM.DOCUMENT_NUM AS "dmNum",
        		DM.DOCUMENT_TITLE AS "dmTitle",
        		APS.APPROVAL_NAME AS "apName",
        		DOCUMENT_DATE AS "dmDate",
				ROWNUM AS RNUM
        		FROM MM
        		INNER JOIN DM
        		ON MM.COMPANY_CODE = DM.COMPANY_CODE
        		INNER JOIN APS
        		ON DM.APPROVAL_CODE = APS.APPROVAL_CODE
        		WHERE WRITER = #{senderId} AND DOCUMENT_CODE='E'
				AND ROWNUM <= #{page} * #{perPageNum}) 
				WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select>
	 
	<select id="countWaitList" resultType="Integer">
	<![CDATA[
		SELECT COUNT(*) 
		FROM DM 
        INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM
        INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID
        INNER JOIN DS ON DM.DOCUMENT_CODE = DS.DOCUMENT_CODE
        WHERE DM.APPROVAL_CODE = 'P' 
       	AND AL.SIGN_LOCATION IS NULL 
		AND AL.APPROVAL_ID=#{senderId} 
        AND AL.APPROVAL_SEQ>=(SELECT MIN(APPROVAL_SEQ)
        FROM AL
        WHERE SIGN_LOCATION IS NULL AND APPROVAL_ID=#{senderId})
	]]>
	</select>
	
	
	 
	<select id="waitApproval" parameterType="hashmap"  resultType="hashmap">
		<![CDATA[		
			SELECT * FROM(
			SELECT 
			DM.DOCUMENT_NUM AS "dmNum",
        	DM.DOCUMENT_TITLE AS "dmTitle",
        	DS.DOCUMENT_TITLE AS "dmCode",
        	MM.NAME AS "dmWriter",
        	DOCUMENT_DATE AS "dmDate",
			ROWNUM AS RNUM
			FROM DM 
        	INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM 
        	INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID 
        	INNER JOIN DS ON DM.DOCUMENT_CODE = DS.DOCUMENT_CODE 
        	WHERE 
			DM.APPROVAL_CODE = 'P' 
       		AND AL.SIGN_LOCATION IS NULL 
			AND AL.APPROVAL_ID=#{senderId} 
        	AND AL.APPROVAL_SEQ>=(SELECT MIN(APPROVAL_SEQ) 
        	FROM AL 
        	WHERE SIGN_LOCATION IS NULL AND APPROVAL_ID=#{senderId})
			AND ROWNUM <= #{page} * #{perPageNum}) 
			WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select>
	 
	<select id = "countApprovalProceed" resultType = "Integer">
		SELECT COUNT(*) 
		FROM DM INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM 
        INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID 
        INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE 
        WHERE DM.APPROVAL_CODE = 'P' AND AL.APPROVAL_ID = #{senderId} 
		AND AL.APPROVAL_SEQ_CHECK='C'
        AND AL.SIGN_LOCATION IS NOT NULL 
	</select>
 
	<select id="approvalProcced" parameterType="hashmap"  resultType="hashmap">
	<![CDATA[		
			SELECT * FROM(
			SELECT   
				DM.DOCUMENT_NUM AS "dmNum",
        		DM.DOCUMENT_TITLE AS "dmTitle",
       		 	DS.DOCUMENT_TITLE AS "dmCode",
        		MM.NAME AS "dmWriter",
        		DOCUMENT_DATE AS "dmDate",
				ROWNUM AS RNUM 
        		FROM DM 
				INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM 
        		INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID 
        		INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE 
        		WHERE DM.APPROVAL_CODE = 'C' AND AL.APPROVAL_ID = #{senderId} 
				AND AL.APPROVAL_SEQ_CHECK='C' AND AL.SIGN_LOCATION IS NOT NULL
				AND ROWNUM <= #{page} * #{perPageNum}) 
				WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select>
	
	<select id="countCompletedDocs" resultType ="Integer">
		SELECT COUNT(*) 
		FROM DM INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM
        INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID
        INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE
        WHERE DM.APPROVAL_CODE = 'C' AND AL.APPROVAL_ID = #{senderId}
	</select>  
	  
	<select id="completeApproval" parameterType="hashmap" resultType="hashmap">
	<![CDATA[		
			SELECT * FROM(
			SELECT   
				DM.DOCUMENT_NUM AS "dmNum",
        		DM.DOCUMENT_TITLE AS "dmTitle",
       		 	DS.DOCUMENT_TITLE AS "dmCode",
        		MM.NAME AS "dmWriter",
        		DOCUMENT_DATE AS "dmDate",
				ROWNUM AS RNUM 
        		FROM DM 
				INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM 
        		INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID 
        		INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE 
        		WHERE DM.APPROVAL_CODE = 'C' AND AL.APPROVAL_ID = #{senderId} 
				AND ROWNUM <= #{page} * #{perPageNum}) 
				WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select>
	
	<select id="countReturnedDocs" resultType="Integer">
		SELECT COUNT(*) 
		FROM DM INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM 
        INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID 
        INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE 
        WHERE DM.APPROVAL_CODE = 'R' AND AL.APPROVAL_ID = #{senderId} 
	</select>
	  		
	<select id="returnedApproval" parameterType="hashmap" resultType="hashmap">
		<![CDATA[		
				SELECT * FROM(
				SELECT   
				DM.DOCUMENT_NUM AS "dmNum",
        		DM.DOCUMENT_TITLE AS "dmTitle",
       		 	DS.DOCUMENT_TITLE AS "dmCode",
        		MM.NAME AS "dmWriter",
        		DOCUMENT_DATE AS "dmDate",
				ROWNUM AS RNUM 
        		FROM DM 
				INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM 
        		INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID 
        		INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE 
        		WHERE DM.APPROVAL_CODE = 'R' AND AL.APPROVAL_ID = #{senderId} 
				AND ROWNUM <= #{page} * #{perPageNum}) 
				WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select>
	
	<select id="countdeferredDocs" resultType="Integer">
		SELECT COUNT(*) 
		FROM DM INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM 
        INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID 
        INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE 
        WHERE DM.APPROVAL_CODE = 'D' AND AL.APPROVAL_ID = #{senderId} 
	</select>
	
	<select id="deferredApproval" parameterType="hashmap" resultType="hashmap">
		<![CDATA[		
				SELECT * FROM(
				SELECT   
				DM.DOCUMENT_NUM AS "dmNum",
        		DM.DOCUMENT_TITLE AS "dmTitle",
       		 	DS.DOCUMENT_TITLE AS "dmCode",
        		MM.NAME AS "dmWriter",
        		DOCUMENT_DATE AS "dmDate",
				ROWNUM AS RNUM 
        		FROM DM 
				INNER JOIN AL ON DM.DOCUMENT_NUM = AL.DOCUMENT_NUM 
        		INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID 
        		INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE 
        		WHERE DM.APPROVAL_CODE = 'D' AND AL.APPROVAL_ID = #{senderId} 
				AND ROWNUM <= #{page} * #{perPageNum}) 
				WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select>

	<select id="countReferredDocs" resultType="Integer">
		SELECT COUNT(*) 
		FROM DM 
        INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID
        INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE
        INNER JOIN RF ON DM.DOCUMENT_NUM=RF.DOCUMENT_NUM
        INNER JOIN RD ON DM.DOCUMENT_NUM=RD.DOCUMENT_NUM
        WHERE RF.REFERENCE_ID=#{senderId} OR RD.READER_ID=#{senderId} 
	</select>
        
  <select id="referenceApproval" parameterType="hashmap" resultType="hashmap">
		<![CDATA[		
				SELECT * FROM(
				SELECT  DM.DOCUMENT_NUM AS "dmNum",
        		DM.DOCUMENT_TITLE AS "dmTitle",
        		DS.DOCUMENT_TITLE AS "dmCode",
        		MM.NAME AS "dmWriter",
        		DOCUMENT_DATE AS "dmDate",
				ROWNUM AS RNUM 
        		FROM DM 
        		INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER=MM.ID
        		INNER JOIN DS ON DM.DOCUMENT_CODE=DS.DOCUMENT_CODE
        		INNER JOIN RF ON DM.DOCUMENT_NUM=RF.DOCUMENT_NUM
        		INNER JOIN RD ON DM.DOCUMENT_NUM=RD.DOCUMENT_NUM
        		WHERE RF.REFERENCE_ID=#{senderId} OR RD.READER_ID=#{senderId}    
				AND ROWNUM <= #{page} * #{perPageNum}) 
				WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select>
	
	<select id="countReceiveDocs" resultType="Integer">
		SELECT COUNT(*) 
		FROM RL 
		INNER JOIN CM ON RL.COMPANY_CODE = CM.COMPANY_CODE
		WHERE RL.RECEIVE_COMPANY= #{senderId} 
	</select>
	
	<select id="receiveList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[		
				SELECT * FROM(
				SELECT  
				RL.DOCUMENT_NUM AS "dmNum",
        		RL.DOCUMENT_TITLE AS "dmTitle",
        		DS.DOCUMENT_TITLE AS "dmCode",
        		RL.COMPANY_CODE AS "sentCmCode",
				CM.COMPANY_NAME AS "cmName",
        		DOCUMENT_DATE AS "dmDate",
				MM.NAME AS "writer", 
				ROWNUM AS RNUM 
        		FROM RL 
        		INNER JOIN DS ON RL.DOCUMENT_TYPE = DS.DOCUMENT_CODE
        		INNER JOIN CM ON RL.COMPANY_CODE = CM.COMPANY_CODE 
				INNER JOIN MM ON RL.WRITER = MM.ID
        		WHERE RL.RECEIVE_COMPANY = #{senderId}      
				AND ROWNUM <= #{page} * #{perPageNum}) 
				WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select>
	
	<select id="countMyList" resultType="Integer">
		SELECT COUNT(*) FROM PL WHERE ID=#{senderId}
	</select>
	
	<select id="myList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[		
				SELECT * FROM(
				SELECT  DM.DOCUMENT_NUM AS "dmNum",
        		DM.DOCUMENT_TITLE AS "dmTitle",
        		DS.DOCUMENT_TITLE AS "dmCode",
        		MM.NAME AS "dmWriter",
        		DOCUMENT_DATE AS "dmDate",
				ROWNUM AS RNUM 
        		FROM DM 
                INNER JOIN PL ON dm.document_num = pl.document_num
        		INNER JOIN MM ON DM.COMPANY_CODE = MM.COMPANY_CODE AND DM.WRITER = MM.ID
        		INNER JOIN DS ON DM.DOCUMENT_CODE = DS.DOCUMENT_CODE
        		WHERE PL.ID = #{senderId}    
				AND ROWNUM <= #{page} * #{perPageNum}) 
				WHERE RNUM > (#{page} -1) * #{perPageNum} 
		]]>
	</select>        	

	<insert id="insTemporary" parameterType="DocumentBean">
		INSERT INTO TL (DOCUMENT_NUM, WRITER, DOCUMENT_TITLE, DOCUMENT_DATE, COMPANY_CODE, DOCUMENT_CODE) VALUES(CONCAT(#{cmCode}, TEMP_SEQ.NEXTVAL), #{dmWriteId}, #{dmTitle}, TO_CHAR(SYSDATE), #{cmCode}, #{dmCode})
	</insert>
        	
	<select id="selTemporary" parameterType="DocumentBean" resultType="DocumentBean">
		SELECT DOCUMENT_NUM AS "dmNum", DOCUMENT_DATE AS "dmDate" FROM TL WHERE WRITER = #{dmWriteId} AND DOCUMENT_TITLE = #{dmTitle} AND COMPANY_CODE = #{cmCode}
	</select>
        	
	<select id="selDmCode" parameterType="String" resultType="String">
		SELECT DOCUMENT_NUM AS "dmNum" FROM TL WHERE WRITER = #{dmWriteId} AND DOCUMENT_TITLE = #{dmTitle} AND COMPANY_CODE = #{cmCode}
	</select>
        	
	<update id="upTemporary" parameterType="DocumentBean">
		UPDATE TL SET DOCUMENT_TITLE = #{dmTitle}, DOCUMENT_DATE = TO_CHAR(SYSDATE) WHERE DOCUMENT_NUM = #{dmNum}
	</update>
        	
	<delete id="delTemporary">
		DELETE FROM TEMPORARYLIST WHERE DOCUMENT_NUM = #{dmNum}
	</delete>
	
</mapper>